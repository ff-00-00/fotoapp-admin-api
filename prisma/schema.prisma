// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Moneda {
  ARS
  USD
}

enum TipoCarrera {
  RUNNING
  BICI
  OTRO
}

enum TipoProducto {
  PREVENTA
  PACK
  UNIDAD
  OTRO
}


model Usuario {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  nombre    String
  hash      String
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
}

model Organizacion {
  id         Int      @id @default(autoincrement())
  nombre     String
  tipo       String // "organizador" | "proveedor"
  provPct    Decimal? @db.Decimal(6, 4)
  orgPrePct  Decimal? @db.Decimal(6, 4)
  orgPostPct Decimal? @db.Decimal(6, 4)

  // relaciones
  comoOrganizador Carrera[] @relation("OrgCarrera")
  comoProveedor   Carrera[] @relation("ProvCarrera")
}

model Fotografo {
  id              Int                 @id @default(autoincrement())
  nombre          String
  mail            String? 
  telefono        String?
  ubicacion       String?
  cuit            String?
  dni             String?
  cbu             String?
  alias           String?
  tipoFacturacion String?            // "Mono", "RI", "CF", etc.
  notas           String?

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  registros RegistroFotografo[]
  carreras        CarreraFotografo[]
}


model Carrera {
  id         Int      @id @default(autoincrement())
  nombre     String
  fecha      DateTime
  monedaBase Moneda   @default(ARS)

  organizadorId Int?
  proveedorId   Int?
  organizador   Organizacion? @relation("OrgCarrera", fields: [organizadorId], references: [id])
  proveedor     Organizacion? @relation("ProvCarrera", fields: [proveedorId], references: [id])

  ingresoARSCents BigInt @default(0) @db.BigInt // ventas totales ARS (centavos)
  ingresoUSDCents BigInt @default(0) @db.BigInt // ventas totales USD (centavos)

  mpPct      Decimal? @db.Decimal(6, 4)
  ibPct      Decimal? @db.Decimal(6, 4)
  ivaPct     Decimal? @db.Decimal(6, 4)
  provPct    Decimal? @db.Decimal(6, 4) // override proveedor
  orgPrePct  Decimal? @db.Decimal(6, 4) // override organizador preventa
  orgPostPct Decimal? @db.Decimal(6, 4) // override organizador post
  debCredPct Decimal? @db.Decimal(6,4)


  pedidosMeta        PedidosMeta?
  lugar      String?
  tipo       TipoCarrera?
  corredores Int?
  accesos    Int?

  ventaTipos   CarreraVentaTipo[]
  fotografos   CarreraFotografo[]

  registros     RegistroFotografo[]
  preventas     CarreraPreventa[]
  transacciones Transaccion[]
  gastosEspecificos GastoEspecifico[]

}

model CarreraVentaTipo {
  id          Int        @id @default(autoincrement())
  carreraId   Int
  carrera     Carrera    @relation(fields: [carreraId], references: [id], onDelete: Cascade)

  nombre      String
  tipo        TipoProducto
  moneda      Moneda

  precioCents BigInt     @db.BigInt
  cantidad    Int
  comisionPct Decimal?    @db.Decimal(6,4)

  @@index([carreraId])
  @@map("carrera_venta_tipo")
}

model GastoEspecifico {
  id         Int      @id @default(autoincrement())
  carreraId  Int
  carrera    Carrera  @relation(fields: [carreraId], references: [id], onDelete: Cascade)

  nombre     String
  tipo       String?
  montoCents BigInt   @default(0) @db.BigInt
  pagado     Boolean  @default(false)
  facturado  Boolean  @default(false)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([carreraId])
}


model PedidosMeta {
  id                     Int     @id @default(autoincrement())
  carreraId              Int     @unique
  preventaCount          Int     @default(0)
  preventaPriceCents     BigInt  @default(0)
  ventaPackCount         Int     @default(0)
  ventaPackPriceCents    BigInt  @default(0)
  ventaFotoCount         Int     @default(0)
  ventaFotoPriceCents    BigInt  @default(0)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  carrera                Carrera  @relation(fields: [carreraId], references: [id], onDelete: Cascade)

  @@map("pedidos_meta")
}

model RegistroFotografo {
  id              Int      @id @default(autoincrement())
  carreraId       Int
  fotografoId     Int
  rol             String
  horas           Decimal  @db.Decimal(8, 2) // horas variables
  tarifaHoraCents BigInt?  @db.BigInt
  tarifaFijaCents BigInt?  @db.BigInt
  plusPct         Decimal? @db.Decimal(6, 4)
  plusCents       BigInt?  @db.BigInt
  pagoEstado      String? // opcional
  facturaEstado   String? // opcional

  carrera   Carrera   @relation(fields: [carreraId], references: [id], onDelete: Cascade)
  fotografo Fotografo @relation(fields: [fotografoId], references: [id])
}

model PreventaTipo {
  id     Int               @id @default(autoincrement())
  codigo String            @unique // "pre1","pre2","socios_adidas"
  nombre String
  usos   CarreraPreventa[]
}

model CarreraPreventa {
  id                  Int    @id @default(autoincrement())
  carreraId           Int
  preventaTipoId      Int
  unidades            Int    @default(0)
  precioUnitarioCents BigInt @db.BigInt
  moneda              Moneda

  carrera Carrera      @relation(fields: [carreraId], references: [id], onDelete: Cascade)
  tipo    PreventaTipo @relation(fields: [preventaTipoId], references: [id])

  @@unique([carreraId, preventaTipoId]) // un tipo de preventa por carrera
}

model TipoMovimiento {
  id      String        @id // ej: "costo_mercadopago"
  nombre  String
  grupo   String // "variable" | "fijo" | "inversion" | "otro"
  alcance String // "carrera" | "global"
  formula String?
  usos    Transaccion[]
}

model Transaccion {
  id         Int      @id @default(autoincrement())
  fecha      DateTime @default(now())
  carreraId  Int?
  tipoId     String
  grupo      String
  montoCents BigInt   @db.BigInt
  moneda     Moneda
  nota       String?

  carrera Carrera?       @relation(fields: [carreraId], references: [id], onDelete: Cascade)
  tipo    TipoMovimiento @relation(fields: [tipoId], references: [id])
}

model ParametroFiscal {
  id     Int       @id @default(autoincrement())
  pais   String    @default("AR")
  desde  DateTime
  hasta  DateTime?
  mpPct  Decimal?  @db.Decimal(6, 4)
  ibPct  Decimal?  @db.Decimal(6, 4)
  ivaPct Decimal?  @db.Decimal(6, 4)
}

model CarreraFotografo {
  id               Int      @id @default(autoincrement())
  carreraId        Int
  carrera          Carrera  @relation(fields: [carreraId], references: [id])

  nombre           String
  costoCents       BigInt   @default(0) @db.BigInt
  fotosTomadas     Int      @default(0)
  descargas        Int      @default(0)
  descargasUnicas  Int      @default(0)
  facturo          Boolean  @default(false)
  pagado           Boolean  @default(false)
  horasTrabajadas  Decimal  @default(0) @db.Decimal(8, 2)
  rol              String?

  fotografoId     Int?
  fotografo       Fotografo? @relation(fields: [fotografoId], references: [id])

  @@index([carreraId])
  @@map("carrera_fotografo")
}





